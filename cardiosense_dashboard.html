<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardioSense - Login</title>
    <link rel="stylesheet" href="./static/css/output.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .metric-card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
            border: 1px solid #e5e7eb;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.07);
        }

        .pulse-live {
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.7;
            }
        }

        .alert-banner {
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .view-toggle-btn {
            transition: all 0.2s ease-in-out;
        }

        .view-toggle-btn.active {
            background-color: #ef4444;
            color: white;
            box-shadow: 0 4px 14px 0 rgb(0 0 0 / 10%);
        }

        #chat-window {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .chat-bubble-user {
            background-color: #ef4444;
            color: white;
        }

        .chat-bubble-bot {
            background-color: #e5e7eb;
            color: #1f2937;
        }

        .risk-value {
            transition: color 0.5s ease-in-out;
        }

        .fade-out {
            animation: fadeOut 0.5s forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .hidden {
            display: none !important;
        }

        /* New Voice UI Styles */
        .mic-active {
            color: #ef4444;
            animation: mic-pulse 1s infinite alternate;
        }

        @keyframes mic-pulse {
            from {
                transform: scale(1);
                opacity: 1;
            }

            to {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-xl">
            <div class="text-center">
                <div class="flex items-center justify-center space-x-3 mb-4">
                    <svg class="w-12 h-12 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                    </svg>
                    <h1 class="text-3xl font-bold text-gray-900">CardioSense</h1>
                </div>
                <p id="auth-instruction" class="text-gray-600">Please sign in to access your health dashboard.</p>
            </div>

            <form id="login-form" class="mt-8 space-y-6">
                <div class="space-y-4">
                    <div>
                        <input id="username" name="username" type="text" required
                            class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400"
                            placeholder="Username">
                    </div>
                    <div>
                        <input id="password" name="password" type="password" required
                            class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400"
                            placeholder="Password">
                    </div>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">Invalid username or password.
                </div>
                <div>
                    <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent text-lg font-medium rounded-lg text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform hover:scale-105">
                        Sign In
                    </button>
                </div>
                <p class="text-center text-sm text-gray-500">
                    New user? <a href="#" id="go-to-signup" class="text-red-500 font-semibold hover:underline">Sign Up
                        here</a>
                </p>
            </form>

            <form id="signup-form" class="mt-8 space-y-4 hidden">
                <div class="space-y-4">
                    <input id="new-username" type="text" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400"
                        placeholder="Choose Username">
                    <input id="new-password" type="password" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400"
                        placeholder="Create Password">
                    <div class="text-left">
                        <label class="block text-gray-700 text-xs font-bold mb-1 ml-1" for="new-dob">DATE OF
                            BIRTH</label>
                        <input id="new-dob" type="date" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400">
                    </div>
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="terms" type="checkbox" required
                                class="focus:ring-red-500 h-4 w-4 text-red-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="terms" class="font-medium text-gray-700">I agree to the <a href="#"
                                    class="text-red-500 hover:underline">Terms of Service</a> and <a href="#"
                                    class="text-red-500 hover:underline">Privacy Policy</a>.</label>
                        </div>
                    </div>
                </div>
                <div id="signup-success" class="text-green-600 text-sm text-center hidden">Account created! You can now
                    sign in.</div>
                <button type="submit"
                    class="w-full py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Create
                    Account</button>
                <p class="text-center text-sm text-gray-500">
                    Already have an account? <a href="#" id="go-to-login"
                        class="text-red-500 font-semibold hover:underline">Sign In</a>
                </p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-red-50 p-2 rounded-lg">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900 tracking-tight">CardioSense</h1>
                </div>

                <div class="flex items-center space-x-3">
                    <p id="patient-name" class="hidden"></p>

                    <div id="patient-initials"
                        class="w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center font-bold shadow-sm ring-2 ring-red-50">
                        --
                    </div>

                    <div class="relative ml-2">
                        <button id="menu-button"
                            class="flex items-center justify-center w-8 h-8 hover:bg-gray-100 rounded-md transition-all text-gray-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>

                        <div id="dropdown-menu"
                            class="hidden absolute right-0 mt-2 w-44 bg-white rounded-lg shadow-xl border border-gray-100 py-1 z-50 overflow-hidden">
                            <button id="nav-clear-history"
                                class="w-full text-left px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-red-50 hover:text-red-500 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Clear History
                            </button>
                            <button id="logout-btn"
                                class="w-full text-left px-3 py-2 text-xs font-bold text-red-500 hover:bg-red-50 flex items-center gap-2 transition-colors">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                                Log Out
                            </button>
                        </div>
                    </div>
                </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="alert-container" class="mb-6 sticky top-24 z-20"></div>

            <div id="controls" class="flex justify-center mb-8 space-x-4">
                <button id="start-button"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105">
                    Begin Real-Time Monitoring
                </button>
                <button id="stop-button"
                    class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105">
                    Stop Monitoring
                </button>
            </div>

            <div id="dashboard" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div class="metric-card p-4 md:p-6 text-center">
                        <h2 class="text-md font-semibold text-gray-600">Heart Rate</h2>
                        <p class="text-4xl md:text-5xl font-bold mt-2" id="hr-value">--</p>
                        <p class="text-xs text-gray-500 mt-1">BPM</p>
                    </div>
                    <div class="metric-card p-4 md:p-6 text-center">
                        <h2 class="text-md font-semibold text-gray-600">SpO2</h2>
                        <p class="text-4xl md:text-5xl font-bold mt-2" id="spo2-value">--</p>
                        <p class="text-xs text-gray-500 mt-1">% Saturation</p>
                    </div>
                    <div class="metric-card p-4 md:p-6 text-center">
                        <h2 class="text-md font-semibold text-gray-600">HRV</h2>
                        <p class="text-4xl md:text-5xl font-bold mt-2" id="hrv-value">--</p>
                        <p class="text-xs text-gray-500 mt-1">ms</p>
                    </div>

                    <div class="metric-card p-4 md:p-6 text-center">
                        <h2 class="text-md font-semibold text-gray-600">Blood Pressure</h2>
                        <p class="text-4xl md:text-5xl font-bold mt-2" id="bp-value">--/--</p>
                        <p class="text-xs text-gray-500 mt-1">mmHg (PAT Est.)</p>
                    </div>

                    <div id="risk-card" class="metric-card p-4 md:p-6 text-center border-2 border-transparent">
                        <h2 class="text-md font-semibold text-gray-600">Heart Attack Risk</h2>
                        <p class="text-4xl md:text-5xl font-bold mt-2 risk-value" id="risk-value">--</p>
                        <p class="text-xs text-gray-500 mt-1">Prediction</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mb-6 bg-gray-200 rounded-full p-1 max-w-sm mx-auto">
                <button id="live-view-btn"
                    class="view-toggle-btn active w-full py-2 px-4 rounded-full font-semibold">Live Monitor</button>
                <button id="history-view-btn"
                    class="view-toggle-btn w-full py-2 px-4 rounded-full font-semibold">Historical Data</button>
            </div>

            <div id="live-dashboard">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3 metric-card p-6 h-96">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">Live ECG & PPG Signals</h2>
                            <div id="live-indicator" class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-gray-300 rounded-full"></div><span>Connecting...</span>
                            </div>
                        </div>
                        <canvas id="ecgChart"></canvas>
                    </div>
                    <div class="lg:col-span-2 metric-card p-6 h-96">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">AI Recommendations</h2>
                        <div id="recommendations-container" class="space-y-4 overflow-y-auto h-72 pr-2">
                            <p class="text-gray-500">Begin monitoring to receive health insights...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="historical-dashboard" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="metric-card p-6 h-80">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Heart Rate (Last 24 Hours)</h2><canvas
                            id="hrHistoryChart"></canvas>
                    </div>
                    <div class="metric-card p-6 h-80">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">SpO2 (Last 7 Days)</h2><canvas
                            id="spo2HistoryChart"></canvas>
                    </div>
                </div>
            </div>
    </div>
    </main>

    <div id="chatbot-container" class="fixed bottom-6 right-6 z-30">
        <div id="chat-window"
            class="hidden absolute bottom-20 right-0 w-80 h-96 bg-white rounded-2xl shadow-2xl flex flex-col transform translate-y-4 opacity-0">
            <div class="p-4 bg-red-500 text-white rounded-t-2xl flex justify-between items-center">
                <h3 class="font-bold">CardioSense Assistant</h3>
                <button id="close-chat-btn" class="text-white text-2xl leading-none">&times;</button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 flex flex-col"></div>
            <form id="chat-form" class="p-4 border-t border-gray-200 flex items-center gap-2">
                <button type="button" id="voice-input-btn" class="text-gray-400 hover:text-red-500 transition-colors">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                        <path
                            d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                    </svg>
                </button>
                <input type="text" id="chat-input"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400"
                    placeholder="Ask a question...">
                <button type="submit" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                        </path>
                    </svg>
                </button>
            </form>
        </div>
        <button id="chat-toggle-btn"
            class="bg-red-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center transform hover:scale-110 transition-transform">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                </path>
            </svg>
        </button>
    </div>
    </div>

    <script>
        const elements = {
            loginPage: document.getElementById('login-page'),
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            loginError: document.getElementById('login-error'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            appContainer: document.getElementById('app-container'),
            patientName: document.getElementById('patient-name'),
            patientInitials: document.getElementById('patient-initials'),
            startButton: document.getElementById('start-button'),
            stopButton: document.getElementById('stop-button'),
            dashboard: document.getElementById('dashboard'),
            hrValue: document.getElementById('hr-value'),
            spo2Value: document.getElementById('spo2-value'),
            hrvValue: document.getElementById('hrv-value'),
            dobInput: document.getElementById('new-dob'), // NEW
            bpValue: document.getElementById('bp-value'), // NEW
            riskCard: document.getElementById('risk-card'),
            riskValue: document.getElementById('risk-value'),
            liveIndicator: document.getElementById('live-indicator'),
            alertContainer: document.getElementById('alert-container'),
            ecgCanvas: document.getElementById('ecgChart'),
            hrHistoryCanvas: document.getElementById('hrHistoryChart'),
            spo2HistoryCanvas: document.getElementById('spo2HistoryChart'),
            recommendationsContainer: document.getElementById('recommendations-container'),
            liveViewBtn: document.getElementById('live-view-btn'),
            historyViewBtn: document.getElementById('history-view-btn'),
            liveDashboard: document.getElementById('live-dashboard'),
            historicalDashboard: document.getElementById('historical-dashboard'),
            chatToggleButton: document.getElementById('chat-toggle-btn'),
            chatWindow: document.getElementById('chat-window'),
            closeChatButton: document.getElementById('close-chat-btn'),
            chatMessages: document.getElementById('chat-messages'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            voiceBtn: document.getElementById('voice-input-btn')
        };

        // NEW: Age Calculation Function
        function calculateAge(dobString) {
            const today = new Date();
            const birthDate = new Date(dobString);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        let monitoringInterval;
        let charts = {};
        let isChatOpen = false;
        let chatHistoryData = {};

        let trendMemory = {
            hr: [],
            spo2: [],
            hrv: []
        };

        let hrHistory = [];
        let spo2History = [];

        let latestVitalsCache = null;


        // --- Signal Processing & Clinical States ---
        let lastRPeakTime = 0;
        let lastPPGPeakTime = 0;
        let rrIntervals = [];
        let filteredECG = 0;
        const alpha = 0.3; // Low-pass filter smoothing factor

        // Calculates real HRV using RMSSD (Root Mean Square of Successive Differences)
        function calculateRealHRV(rawECGValue) {
            filteredECG = (alpha * rawECGValue) + ((1 - alpha) * filteredECG);
            const now = Date.now();
            const threshold = 2500;

            if (filteredECG > threshold && (now - lastRPeakTime) > 400) {
                if (lastRPeakTime > 0) {
                    rrIntervals.push(now - lastRPeakTime);
                    if (rrIntervals.length > 20) rrIntervals.shift();
                }
                lastRPeakTime = now;
            }

            // MISTAKE FIX: Do not return '45'. Return null if not ready.
            if (rrIntervals.length < 5) return null;

            let sumDiffSq = 0;
            for (let i = 1; i < rrIntervals.length; i++) {
                sumDiffSq += Math.pow(rrIntervals[i] - rrIntervals[i - 1], 2);
            }
            return Math.sqrt(sumDiffSq / (rrIntervals.length - 1)).toFixed(1);
        }

        // Estimates Blood Pressure using Pulse Arrival Time (PAT)
        function estimateBP(ecgValue, ppgValue) {
            const now = Date.now();

            // Detect PPG Peak from MAX30100
            if (ppgValue > 600 && (now - lastPPGPeakTime) > 400) {
                lastPPGPeakTime = now;
            }

            // Calculate delay between ECG R-Peak and PPG Pulse Peak
            const pat = Math.abs(lastPPGPeakTime - lastRPeakTime);

            // Inverse Relationship: Higher pressure results in faster pulse travel (lower PAT)
            let systolic = 120 + (250 - pat) * 0.15;

            // Limit to human physiological ranges
            systolic = Math.max(95, Math.min(175, systolic));
            let diastolic = systolic * 0.65;

            return {
                sys: Math.round(systolic),
                dia: Math.round(diastolic)
            };
        }
        function loadUserHistory() {
            hrHistory = JSON.parse(localStorage.getItem(`hrHistory_${currentUsername}`)) || [];
            spo2History = JSON.parse(localStorage.getItem(`spo2History_${currentUsername}`)) || [];
        }

        // ===== Greeting Detection =====
        function isGreeting(text) {
            const greetings = [
                "hi", "hii", "hai", "hello", "hey",
                "good morning", "good afternoon", "good evening"
            ];
            const lower = text.toLowerCase().trim();
            return greetings.includes(lower);
        }

        function getTrendStatus(values) {
            if (values.length < 5) return "stable so far";
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const last = values[values.length - 1];
            return Math.abs(last - avg) < avg * 0.1
                ? "stable over recent readings"
                : "showing noticeable variation";
        }

        const API_KEY = "YOU_API_KEY_HERE";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

        /**
         * 1. VOICE RECOGNITION (Speech-to-Text)
         */
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            elements.voiceBtn.onclick = () => {
                recognition.start();
                elements.voiceBtn.classList.add('mic-active');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                elements.chatInput.value = transcript;
                elements.voiceBtn.classList.remove('mic-active');
                elements.chatForm.dispatchEvent(new Event('submit'));
            };

            recognition.onerror = () => {
                elements.voiceBtn.classList.remove('mic-active');
            };
        } else {
            elements.voiceBtn.style.display = 'none';
        }

        /**
         * 2. VOICE SYNTHESIS (Text-to-Speech)
         */
        function speak(text) {
            if ('speechSynthesis' in window) {
                // Strip HTML tags for cleaner speech
                const cleanText = text.replace(/<\/?[^>]+(>|$)/g, "");
                const utterance = new SpeechSynthesisUtterance(cleanText);
                window.speechSynthesis.speak(utterance);
            }
        }

        document.getElementById('go-to-signup').onclick = (e) => {
            e.preventDefault();
            elements.loginForm.classList.add('hidden');
            elements.signupForm.classList.remove('hidden');
            document.getElementById('auth-instruction').textContent = "Join CardioSense to monitor your heart.";
        };

        document.getElementById('go-to-login').onclick = (e) => {
            e.preventDefault();
            elements.signupForm.classList.add('hidden');
            elements.loginForm.classList.remove('hidden');
            document.getElementById('auth-instruction').textContent = "Please sign in to access your health dashboard.";
        };

        elements.signupForm.onsubmit = (e) => {
            e.preventDefault();
            const user = document.getElementById('new-username').value.trim();
            const pass = document.getElementById('new-password').value.trim();
            const dob = elements.dobInput.value; // Get the DOB from the new input

            if (user && pass && dob) {
                // Updated: Store as a JSON object to keep the DOB
                localStorage.setItem(`user_${user}`, JSON.stringify({
                    password: pass,
                    dob: dob
                }));
                document.getElementById('signup-success').classList.remove('hidden');
                setTimeout(() => {
                    elements.signupForm.classList.add('hidden');
                    elements.loginForm.classList.remove('hidden');
                    document.getElementById('auth-instruction').textContent = "Please sign in to access your health dashboard.";
                }, 1500);
            }
        };

        elements.loginForm.onsubmit = (e) => {
            e.preventDefault();
            const username = elements.usernameInput.value.trim();
            const password = elements.passwordInput.value.trim();

            // Get the stored string
            const storedData = localStorage.getItem(`user_${username}`);

            if (storedData) {
                // PARSE the JSON string back into an object
                const userData = JSON.parse(storedData);

                // Compare the input password with the stored password field
                if (userData.password === password) {
                    elements.loginError.classList.add('hidden');

                    // Set currentUsername for the dashboard to use later
                    currentUsername = username;

                    loadUserHistory();

                    elements.patientName.textContent = `Patient: ${username}`;
                    const initials = username.split(' ').map(n => n[0]).join('').toUpperCase();
                    elements.patientInitials.textContent = initials.substring(0, 2);

                    elements.loginPage.classList.add('fade-out');
                    setTimeout(() => {
                        elements.loginPage.classList.add('hidden');
                        elements.appContainer.classList.remove('hidden');
                    }, 500);
                    document.title = "CardioSense - Dashboard";
                } else {
                    elements.loginError.classList.remove('hidden');
                    elements.loginError.textContent = "Incorrect password.";
                }
            } else {
                elements.loginError.classList.remove('hidden');
                elements.loginError.textContent = "Username not found.";
            }
        };

        const recommendations = {
            CRITICAL_HR: "Your heart rate is significantly elevated compared to your normal pattern. If you are at rest, this may indicate physical or emotional stress. Please stop any activity, sit or lie down, and focus on slow, deep breathing. If discomfort persists, seek medical attention.",

            ELEVATED_HR: "Your heart rate is slightly higher than usual. This can occur due to stress, recent activity, or stimulants like caffeine. Consider taking a short break and allowing your body to recover.",

            LOW_SPO2: "Your oxygen levels are lower than optimal. Try slow, deep breathing and ensure you are in a well-ventilated environment. If this pattern continues, medical advice is recommended.",

            LOW_HRV: "Your heart rate variability suggests increased physical or mental strain. Prioritizing rest, hydration, and quality sleep may help restore balance.",

            RISING_RISK_TREND: "Your cardiovascular risk indicator shows an upward trend. While not critical, paying attention to stress, sleep, and daily activity is advised.",

            DATA_INSUFFICIENT: "More data is needed to generate personalized insights. Please continue monitoring to enable accurate trend analysis.",

            NORMAL: "Your vital signs are stable and within healthy ranges. Continue your current routine, stay hydrated, and maintain regular monitoring for long-term trends."
        };

        function createAlert(type, message) {
            elements.alertContainer.innerHTML = '';
            let bgColor, icon, title;
            if (type === 'CRITICAL_HR') {
                bgColor = 'bg-red-100 border-red-500 text-red-700';
                title = 'CRITICAL ALERT';
                icon = `<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
            } else {
                bgColor = 'bg-yellow-100 border-yellow-500 text-yellow-700';
                title = 'MILD ANOMALY DETECTED';
                icon = `<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            }
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-banner border-l-4 p-4 rounded-lg shadow-md ${bgColor}`;
            alertDiv.innerHTML = `<div class="flex items-center">${icon}<div><p class="font-bold">${title}</p><p class="text-sm">${message}</p></div></div>`;
            elements.alertContainer.appendChild(alertDiv);
        }

        function updateRecommendations(status) {
            const text = recommendations[status] || recommendations['NORMAL'];
            elements.recommendationsContainer.innerHTML = `<div class="p-4 bg-gray-100 rounded-lg"><p class="font-semibold text-gray-700">Health Insight</p><p class="text-gray-600 text-sm">${text}</p></div>`;
        }

        function updateRiskCard(risk) {
            const riskValueElement = elements.riskValue;
            const riskCardElement = elements.riskCard;

            // Display the percentage from Flask
            riskValueElement.textContent = `${risk}%`;

            // Visual feedback based on risk level
            riskCardElement.classList.remove('border-green-500', 'border-yellow-500', 'border-red-500');

            if (risk >= 60) {
                riskCardElement.classList.add('border-red-500');
                riskValueElement.className = "text-4xl md:text-5xl font-bold mt-2 text-red-600";
            } else if (risk >= 30) {
                riskCardElement.classList.add('border-yellow-500');
                riskValueElement.className = "text-4xl md:text-5xl font-bold mt-2 text-yellow-600";
            } else {
                riskCardElement.classList.add('border-green-500');
                riskValueElement.className = "text-4xl md:text-5xl font-bold mt-2 text-green-600";
            }
        }

        async function updateDashboard() {
            try {
                // 1. Fetch raw real-time data from your ESP32 via Flask
                const iotResponse = await fetch("http://localhost:5000/get-vitals");
                latestVitalsCache = await iotResponse.json();
                const iotData = latestVitalsCache;


                // --- FIX 1: Verify sensor connection before calculating ---
                if (!iotData || iotData.ecg === 0 || iotData.ppg === 0) {
                    elements.hrValue.textContent = "--";
                    elements.spo2Value.textContent = "--";
                    elements.hrvValue.textContent = "--";
                    elements.bpValue.textContent = "--/--";
                    elements.riskValue.textContent = "--";
                    return; // Exit early if sensors are offline
                }

                // 2. Derive clinical features using live sensor timing
                const realHRV = calculateRealHRV(iotData.ecg);
                const realBP = estimateBP(iotData.ecg, iotData.ppg);

                // --- ADD THE MISTAKE FIX HERE ---
                if (!realHRV || realHRV === null || rrIntervals.length < 5) {
                    elements.hrValue.textContent = iotData.hr;
                    elements.spo2Value.textContent = iotData.spo2;
                    elements.hrvValue.textContent = "--";
                    elements.bpValue.textContent = "--/--";
                    elements.riskValue.textContent = "--";
                    return; // Stop here and wait for more heartbeats
                }
                // --------------------------------

                // 3. Get User Profile for Age
                const userProfile = JSON.parse(localStorage.getItem(`user_${currentUsername}`));
                if (!userProfile) throw new Error("User profile not found");
                const age = calculateAge(userProfile.dob);

                // 4. Update UI Cards with valid clinical data
                elements.hrValue.textContent = iotData.hr;
                elements.spo2Value.textContent = iotData.spo2;
                elements.hrvValue.textContent = realHRV;
                elements.bpValue.textContent = `${realBP.sys}/${realBP.dia}`;

                const now = Date.now();

                // 5. Store History (User-Specific)
                hrHistory.push({ value: iotData.hr, time: now });
                spo2History.push({ value: iotData.spo2, time: now });
                localStorage.setItem(`hrHistory_${currentUsername}`, JSON.stringify(hrHistory));
                localStorage.setItem(`spo2History_${currentUsername}`, JSON.stringify(spo2History));

                // 6. Update AI Assistant Memory
                trendMemory.hr.push(iotData.hr);
                trendMemory.spo2.push(iotData.spo2);
                trendMemory.hrv.push(realHRV);
                if (!trendMemory.bp) trendMemory.bp = [];
                trendMemory.bp.push(`${realBP.sys}/${realBP.dia}`);

                if (trendMemory.hr.length > 20) {
                    trendMemory.hr.shift();
                    trendMemory.spo2.shift();
                    trendMemory.hrv.shift();
                    trendMemory.bp.shift();
                }

                // 7. Update Prediction using the 6-Feature Flask API
                const predictResponse = await fetch("http://localhost:5000/predict", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        hr: parseFloat(iotData.hr),
                        spo2: parseFloat(iotData.spo2),
                        hrv: parseFloat(realHRV),
                        systolic: parseFloat(realBP.sys),
                        diastolic: parseFloat(realBP.dia),
                        age: parseInt(age)
                    })
                });

                const result = await predictResponse.json();

                // 8. Handle Real-World Predictions and Alerts
                if (result && result.risk !== undefined) {
                    updateRiskCard(result.risk);

                    if (result.risk >= 60) {
                        createAlert("CRITICAL_HR", "Emergency: High cardiac risk detected.");
                        updateRecommendations("CRITICAL_HR");
                    } else if (result.risk >= 30) {
                        createAlert("RISING_RISK_TREND", "Warning: Elevated cardiac risk.");
                        updateRecommendations("RISING_RISK_TREND");
                    } else {
                        elements.alertContainer.innerHTML = "";
                        updateRecommendations("NORMAL");
                    }
                }
            } catch (error) {
                console.error("IoT Monitoring Cycle Failed:", error);
            }
        }

        let anomalyStep = 0;

        function initializeCharts() {
            // 1. Destroy old chart instances to prevent memory leaks
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            const ecgCtx = elements.ecgCanvas.getContext('2d');
            charts.ecg = new Chart(ecgCtx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'ECG (AD8232)',
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 2,
                            pointRadius: 0,
                            data: [],
                            fill: false,
                            tension: 0.4 // Smooths the line
                        },
                        {
                            label: 'PPG (MAX30100)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 2,
                            pointRadius: 0,
                            data: [],
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'realtime',
                            realtime: {
                                duration: 15000, // Show 15 seconds of data
                                refresh: 100,    // Higher refresh rate for smooth IoT signals
                                delay: 1000,
                                onRefresh: function (chart) {
                                    if (!latestVitalsCache) return;

                                    const now = Date.now();

                                    filteredECG = (alpha * latestVitalsCache.ecg) +
                                        ((1 - alpha) * filteredECG);

                                    chart.data.datasets[0].data.push({
                                        x: now,
                                        y: filteredECG
                                    });

                                    chart.data.datasets[1].data.push({
                                        x: now,
                                        y: latestVitalsCache.ppg
                                    });
                                }

                            }
                        },
                        y: {
                            // Adjust these ranges based on your sensor's output
                            min: 0,
                            max: 4095,
                            ticks: { display: false },
                            grid: { color: '#f3f4f6' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { enabled: false }
                    }
                }
            });

            // --- History Charts (Remain mostly the same, but use currentUsername) ---
            const hrHistoryCtx = elements.hrHistoryCanvas.getContext('2d');
            charts.hrHistory = new Chart(hrHistoryCtx, {
                type: 'line',
                data: {
                    labels: hrHistory.map(d => new Date(d.time).toLocaleTimeString()),
                    datasets: [{
                        label: 'BPM',
                        data: hrHistory.map(d => d.value),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // SpO2 history chart logic using spo2History variable
            const spo2HistoryCtx = elements.spo2HistoryCanvas.getContext('2d');
            const spo2Daily = {};
            spo2History.forEach(d => {
                const day = new Date(d.time).toDateString();
                if (!spo2Daily[day]) spo2Daily[day] = [];
                spo2Daily[day].push(d.value);
            });

            charts.spo2History = new Chart(spo2HistoryCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(spo2Daily),
                    datasets: [{
                        label: '%',
                        data: Object.keys(spo2Daily).map(day =>
                            Math.round(spo2Daily[day].reduce((a, b) => a + b, 0) / spo2Daily[day].length)
                        ),
                        backgroundColor: 'rgb(34, 197, 94)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function toggleChatWindow() {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                elements.chatWindow.classList.remove('hidden');
                setTimeout(() => { elements.chatWindow.classList.remove('translate-y-4', 'opacity-0'); }, 10);
                if (elements.chatMessages.children.length === 0) displayMessage("Hello! I'm the CardioSense assistant. Ask me about your status.", 'bot');
            } else {
                elements.chatWindow.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => { elements.chatWindow.classList.add('hidden'); }, 300);
            }
        }

        function displayMessage(message, sender) {
            const bubble = document.createElement('div');
            bubble.className = `w-fit max-w-xs p-3 rounded-2xl mb-2`;
            if (sender === 'user') bubble.classList.add('chat-bubble-user', 'self-end', 'rounded-br-sm', 'ml-auto');
            else bubble.classList.add('chat-bubble-bot', 'self-start', 'rounded-tl-sm', 'mr-auto');
            bubble.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            elements.chatMessages.appendChild(bubble);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            return bubble;
        }

        function getRiskTone(riskText) {
            const risk = parseFloat(riskText);
            if (risk < 30) return "reassuring and positive";
            if (risk < 60) return "cautious and advisory";
            return "urgent and safety-focused";
        }

        async function getBotResponse(userInput) {
            // Handle greetings politely
            if (isGreeting(userInput)) {
                if (monitoringInterval) {
                    return "Hello! ðŸ‘‹ Would you like me to review your latest heart health readings or answer any specific question?";
                } else {
                    return "Hello! ðŸ‘‹ You can start monitoring anytime, or ask me general questions about heart health.";
                }
            }

            if (!monitoringInterval) {
                const lowerInput = userInput.toLowerCase();
                if (['hrv', 'heart rate', 'spo2', 'ecg', 'risk'].some(kw => lowerInput.includes(kw))) {
                    return "Please start the monitoring first so I can access your current health data!";
                }
            }
            const systemPrompt = `You are CardioSense, an AI-powered cardiac health assistant.Use calm, medical, and reassuring language.Interpret heart rate, SpO2, HRV, and risk score.Mention stability or trends when possible.Do NOT diagnose diseases.If risk is low, reassure.If risk is moderate, advise caution.If risk is high, be safety-focused.Always recommend consulting a healthcare professional.Limit responses to 3â€“5 sentences.`;
            let dataContext = "The user is not currently monitoring their data.";

            if (monitoringInterval) {
                const hrTrend = getTrendStatus(trendMemory.hr);
                const spo2Trend = getTrendStatus(trendMemory.spo2);
                const hrvTrend = getTrendStatus(trendMemory.hrv);

                dataContext = `
            Current cardiac data:
            - Heart Rate: ${elements.hrValue.textContent} BPM (${hrTrend})
            - SpO2: ${elements.spo2Value.textContent}% (${spo2Trend})
            - HRV: ${elements.hrvValue.textContent} ms (${hrvTrend})
            - Risk Score: ${elements.riskValue.textContent}
            `;
            }

            const tone = monitoringInterval
                ? getRiskTone(elements.riskValue.textContent)
                : "neutral";


            const userQuery = `${dataContext}\n\nUser Question: "${userInput}"`;

            const MAX_RETRIES = 3;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: {
                            parts: [{
                                text: systemPrompt + `\nUse a ${tone} tone in your response.`
                            }]
                        },
                    };
                    const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API failed`);
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "I'm having trouble responding.";
                } catch (error) {
                    if (i === MAX_RETRIES - 1) return "Sorry, I can't connect to AI right now.";
                    await new Promise(res => setTimeout(res, 1000));
                }
            }
        }

        elements.chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = elements.chatInput.value.trim();
            if (userInput) {
                displayMessage(userInput, 'user');
                elements.chatInput.value = '';
                const thinkingBubble = displayMessage("Thinking...", 'bot');
                const botResponse = await getBotResponse(userInput);
                thinkingBubble.innerHTML = botResponse.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

                // SPEAK the response
                speak(botResponse);
            }
        });

        // --- UNIFIED START BUTTON LOGIC ---
        // Unified Start Monitoring Logic
        elements.startButton.onclick = () => {
            // 1. Get user data for the confirmation popup
            const userData = JSON.parse(localStorage.getItem(`user_${currentUsername}`));
            if (!userData) {
                alert("Error: User profile not found. Please log in again.");
                return;
            }
            const age = calculateAge(userData.dob);

            // 2. Multi-User Confirmation
            if (confirm(`Confirming Profile:\nPatient: ${currentUsername}\nCalculated Age: ${age}\n\nIs this correct?`)) {

                // 3. UI Transition
                elements.startButton.classList.add('hidden');
                elements.stopButton.classList.remove('hidden');
                elements.dashboard.classList.remove('hidden');
                elements.liveIndicator.innerHTML = `<div class="w-3 h-3 bg-red-500 rounded-full pulse-live"></div><span>Live</span>`;

                // 4. Initialize real-time components
                initializeCharts();

                // 5. Start the cycle
                updateDashboard(); // Run once immediately so data appears instantly
                monitoringInterval = setInterval(updateDashboard, 1000); // Then repeat every second
            } else {
                alert("Please logout and sign in with the correct profile.");
            }
        };
        elements.stopButton.onclick = () => {
            // 1. Stop the polling interval
            clearInterval(monitoringInterval);
            monitoringInterval = null;

            // 2. Clear "Clinical Memory" (Mathematics Scratchpad)
            // This prevents old heartbeats from affecting new sessions
            rrIntervals = [];
            lastRPeakTime = 0;
            lastPPGPeakTime = 0;

            // 3. Reset Signal Processing variables
            filteredECG = 0;
            latestVitalsCache = null;

            // 4. Update UI to Offline state
            elements.startButton.classList.remove('hidden');
            elements.stopButton.classList.add('hidden');
            elements.dashboard.classList.add('hidden'); // Hides the old metric cards

            // 5. Reset the Live Indicator
            elements.liveIndicator.innerHTML = `
        <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
        <span>Offline</span>
    `;

            // 6. Optional: Provide a summary in the recommendations box
            elements.recommendationsContainer.innerHTML = `
        <p class="text-gray-500 italic">Monitoring session ended. History has been saved.</p>
    `;
        };
        elements.liveViewBtn.onclick = () => {
            elements.liveViewBtn.classList.add('active');
            elements.historyViewBtn.classList.remove('active');
            elements.liveDashboard.classList.remove('hidden');
            elements.historicalDashboard.classList.add('hidden');
            if (monitoringInterval) initializeCharts();
        };
        elements.historyViewBtn.onclick = () => {
            elements.historyViewBtn.classList.add('active');
            elements.liveViewBtn.classList.remove('active');
            elements.historicalDashboard.classList.remove('hidden');
            elements.liveDashboard.classList.add('hidden');
        };
        elements.chatToggleButton.onclick = toggleChatWindow;
        elements.closeChatButton.onclick = toggleChatWindow;

        // --- MENU TOGGLE LOGIC ---
        const menuButton = document.getElementById('menu-button');
        const dropdownMenu = document.getElementById('dropdown-menu');

        menuButton.onclick = (e) => {
            e.stopPropagation(); // Prevents immediate closing
            dropdownMenu.classList.toggle('hidden');
        };

        // Close menu if user clicks anywhere else on the screen
        window.onclick = () => {
            if (!dropdownMenu.classList.contains('hidden')) {
                dropdownMenu.classList.add('hidden');
            }
        };
        // --- LOGOUT LOGIC ---
        document.getElementById('logout-btn').onclick = () => {
            if (confirm("Are you sure you want to log out?")) {
                // Stop the interval directly if it is running
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                }

                currentUsername = null;
                elements.appContainer.classList.add('hidden');
                elements.loginPage.classList.remove('hidden', 'fade-out');
                elements.loginForm.reset();

                // Reset the dashboard view for the next user
                elements.dashboard.classList.add('hidden');
                elements.startButton.classList.remove('hidden');
                elements.stopButton.classList.add('hidden');

                document.title = "CardioSense - Login";
            }
        };

        // --- CLEAR HISTORY LOGIC ---
        document.getElementById('nav-clear-history').onclick = () => {
            if (confirm(`Permanently delete all records for ${currentUsername}?`)) {
                localStorage.removeItem(`hrHistory_${currentUsername}`);
                localStorage.removeItem(`spo2History_${currentUsername}`);
                hrHistory = [];
                spo2History = [];
                if (charts.hrHistory) charts.hrHistory.update();
                if (charts.spo2History) charts.spo2History.update();
                alert("History cleared.");
            }
        };
    </script>
</body>

</html>